<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MileZero° Freight Exchange – Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #0d1117;
      color: #f5f5f5;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .logo span {
      font-size: 0.85em;
      opacity: 0.8;
    }

    nav a {
      margin-left: 16px;
      font-size: 0.9rem;
      text-decoration: none;
      color: #c9d1d9;
    }

    nav a.primary {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #c9d1d9;
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    .hidden {
      display: none;
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 32px;
    }

    .hero-top {
      max-width: 640px;
    }

    .hero-title {
      font-size: 2.2rem;
      margin-bottom: 12px;
    }

    .hero-sub {
      font-size: 0.98rem;
      color: #8b949e;
      line-height: 1.5;
    }

    .badge-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.78rem;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #30363d;
      color: #8b949e;
    }

    .split-cta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .card {
      border-radius: 14px;
      border: 1px solid #30363d;
      padding: 18px 16px;
      background: #161b22;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      border-color: #58a6ff;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 6px;
    }

    .card p {
      font-size: 0.88rem;
      color: #8b949e;
      margin-bottom: 10px;
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #30363d;
      margin-right: 4px;
    }

    .view-header {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .view-header h1 {
      font-size: 1.4rem;
    }

    .view-header small {
      color: #8b949e;
    }

    /* Role-specific header tints */
    #view-shipper .view-header {
      background: #111827; /* slightly lighter blue-ish */
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid #1f2937;
    }

    #view-haulier .view-header {
      background: #020617; /* slightly darker blue-ish */
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid #111827;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #58a6ff;
      background: #1f6feb;
      color: #f5f5f5;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
    }

    .btn.secondary {
      background: transparent;
      border-color: #30363d;
      color: #c9d1d9;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
      margin-bottom: 24px;
    }

    label {
      font-size: 0.8rem;
      color: #8b949e;
      margin-bottom: 2px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #f5f5f5;
      font-size: 0.85rem;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .form-actions {
      grid-column: 1 / -1;
      margin-top: 4px;
    }

    .list {
      margin-top: 8px;
      display: grid;
      gap: 10px;
    }

    .list-item {
      border-radius: 10px;
      border: 1px solid #30363d;
      padding: 10px 12px;
      background: #161b22;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
    }

    .li-main {
      font-size: 0.9rem;
    }

    .li-main strong {
      display: block;
      margin-bottom: 2px;
    }

    .li-meta {
      font-size: 0.76rem;
      color: #8b949e;
    }

    .status {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #30363d;
      display: inline-block;
      margin-top: 4px;
    }

    .li-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .tagline {
      font-size: 0.8rem;
      color: #8b949e;
      margin-top: 4px;
    }

    .alert {
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .alert.error {
      background: #33141a;
      border: 1px solid #f85149;
      color: #ffb3b8;
    }

    .alert.info {
      background: #111827;
      border: 1px solid #30363d;
      color: #9ca3af;
    }

    #detail-map {
      width: 100%;
      height: 320px;
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #30363d;
      background: #0d1117;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .list-item {
        grid-template-columns: 1fr;
      }

      .li-actions {
        align-items: flex-start;
        flex-direction: row;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">MileZero° <span>Freight Exchange</span></div>
  <nav>
    <a href="#" onclick="showView('home'); return false;">Home</a>
    <a href="#" onclick="showView('shipper'); return false;">Shippers</a>
    <a href="#" onclick="showView('haulier'); return false;">Hauliers</a>
    <a href="#" class="primary">Login / Sign up</a>
  </nav>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="view">
    <div class="hero">
      <div class="hero-top">
  <div class="hero-title">
    Our mission at MileZero° is to cut empty transport miles to zero.
  </div>
  <p class="hero-sub">
    We connect shippers and hauliers in real time, giving both sides the ability
    to request and filter work by temperature, weight, trailer type, and
    collection / delivery windows.
  </p>
  <div class="badge-row">
    <span class="badge">Filter by temperature &amp; weight</span>
    <span class="badge">Control collection &amp; delivery windows</span>
    <span class="badge">Reduce empty running</span>
  </div>
</div>
      <div class="split-cta">
        <!-- Shipper card -->
        <div class="card" onclick="showView('shipper')">
          <h2>Shipper View</h2>
          <p>Request transport services on MileZero°</p>
          <div>
            <span class="pill">Chilled / frozen / ambient</span>
            <span class="pill">Set time windows</span>
            <span class="pill">Invite bids</span>
          </div>
        </div>
        <!-- Haulier card -->
        <div class="card" onclick="showView('haulier')">
          <h2>Haulier View</h2>
          <p>Search MileZero° for work that matches your location and equipment</p>
          <div>
            <span class="pill">Input Base Location</span>
            <span class="pill">Search by Temperature</span>
            <span class="pill">Sort by driving time</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SHIPPER VIEW -->
  <section id="view-shipper" class="view hidden">
    <div class="view-header">
      <div>
        <h1>Shipper View</h1>
        <small>Request transport services on MileZero°</small>
      </div>
      <button class="btn secondary" onclick="showView('haulier')">Switch to haulier view</button>
    </div>

    <div id="shipper-alert"></div>

    <form id="shipper-form">
      <div>
        <label>Pickup location (postcode or site)</label>
        <input id="pickup-input" placeholder="e.g. BD4 6SE – Wakefield DC">
      </div>
      <div>
        <label>Delivery location (postcode or RDC)</label>
        <input id="delivery-input" placeholder="e.g. RM9 6BF – Dagenham RDC">
      </div>
      <div>
        <label>Pickup window</label>
        <input id="pickup-window-input" placeholder="24/11/2025 08:00-10:00">
      </div>
      <div>
        <label>Delivery window</label>
        <input id="delivery-window-input" placeholder="24/11/2025 14:00-15:00">
      </div>
      <div>
        <label>Load type</label>
        <select id="load-type-input">
          <option>Chilled</option>
          <option>Frozen</option>
          <option>Ambient</option>
          <option>Mixed</option>
        </select>
      </div>
      <div>
        <label>Trailer type</label>
        <select id="trailer-type-input">
          <option>Single-deck fridge</option>
          <option>Double-deck fridge</option>
          <option>Curtainsider</option>
          <option>Box</option>
        </select>
      </div>
      <div>
        <label>Pallets</label>
        <input id="pallets-input" placeholder="e.g. 26 full pallets">
      </div>
      <div>
        <label>Weight</label>
        <input id="weight-input" placeholder="e.g. 24,000 kg">
      </div>
      <div>
        <label>Retailer ref</label>
        <input id="retailer-input">
      </div>
      <div>
        <label>Temp range</label>
        <input id="temp-range-input" placeholder="e.g. +2°C to +5°C">
      </div>
      <div>
        <label>Time critical?</label>
        <select id="time-critical-input">
          <option>Standard – flexible</option>
          <option>Time-critical – strict</option>
          <option>Same-day</option>
          <option>Next-day</option>
        </select>
      </div>
      <div>
        <label>Target rate (£)</label>
        <input id="target-rate-input" type="number">
      </div>
      <div>
        <label>Notes</label>
        <textarea id="notes-input" placeholder="Tail-lift, cages, booking ref..."></textarea>
      </div>
      <div class="form-actions">
        <button class="btn" type="button" onclick="publishLoad()">Publish load</button>
      </div>
    </form>

    <h2 style="font-size:1rem; margin-bottom:2px;">Your active loads</h2>
    <p class="tagline">Anything you publish appears here and on the haulier list.</p>
    <div id="shipper-load-list" class="list"></div>
  </section>

  <!-- HAULIER VIEW (LIST) -->
  <section id="view-haulier" class="view hidden">
    <div class="view-header">
      <div>
        <h1>Haulier View</h1>
        <small>Search MileZero° for work that matches your location and equipment.</small>
      </div>
      <button class="btn secondary" onclick="showView('shipper')">Switch to shipper view</button>
    </div>

    <div id="haulier-alert"></div>

    <form>
      <div>
        <label>Base location (postcode)</label>
        <input id="haulier-base" placeholder="e.g. OL12 9QJ">
      </div>
      <div>
        <label>Trailer</label>
        <select id="haulier-trailer">
          <option>Any</option>
          <option>Single-deck fridge</option>
          <option>Double-deck fridge</option>
          <option>Curtainsider</option>
        </select>
      </div>
      <div>
        <label>Temperature</label>
        <select id="haulier-temp">
          <option>Any</option>
          <option>Chilled</option>
          <option>Frozen</option>
          <option>Ambient</option>
        </select>
      </div>
      <div>
        <label>Max pallets</label>
        <input id="haulier-max-pallets" type="number" min="1" placeholder="e.g. 26">
      </div>
      <div>
        <label>Max weight (kg)</label>
        <input id="haulier-max-weight" type="number" min="1" placeholder="e.g. 24000">
      </div>
      <div>
        <label>Sort loads by</label>
        <select id="haulier-sort">
          <option value="default">Default</option>
          <option value="deadhead">Shortest distance to collection</option>
          <option value="combined">Shortest combined distance</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn" type="button" onclick="applyHaulierFilters()">Search</button>
      </div>
    </form>

    <h2 style="font-size:1rem; margin-bottom:2px;">Matching loads</h2>
    <p class="tagline">Enter your base to see matched work, filtered by equipment and capacity.</p>
    <p class="tagline">Total Driving = Your current location → Collection → Delivery → Base</p>
    <div id="haulier-load-list" class="list"></div>
  </section>

  <!-- HAULIER LOAD DETAIL VIEW -->
  <section id="view-haulier-detail" class="view hidden">
    <div class="view-header">
      <div>
        <h1>Load details</h1>
        <small>Route breakdown, timings and map for this load.</small>
      </div>
      <button class="btn secondary" type="button" onclick="backToHaulier()">Back to loads</button>
    </div>

    <div id="detail-summary" class="alert info"></div>
    <div id="detail-routes" style="margin-top:8px;"></div>

    <h3 style="margin-top:18px;">Map</h3>
    <div id="detail-map"></div>
  </section>
</main>

<script>
  const USE_BACKEND = false;
  let allLoads = [];

  const haulierFilter = {
    temperature: 'Any',
    trailer: 'Any',
    maxPallets: null,
    maxWeightKg: null
  };
  let sortOption = 'default';

  let map;
  let mapMarkers = [];
  let mainRoutePolyline = null;
  let deadheadPolyline = null;
  let directionsService = null;

  let userLocation = null;
  let userMarker = null;

  let baseCoords = null;
  let baseLocationString = '';

  let selectedLoadId = null;

  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const el = document.getElementById('view-' + name);
    if (el) el.classList.remove('hidden');
    window.scrollTo(0, 0);
  }

  function backToHaulier(){
    showView('haulier');
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function parseNumberFromText(text) {
    if (!text) return null;
    const cleaned = String(text).replace(/,/g,'');
    const m = cleaned.match(/[\d.]+/);
    return m ? Number(m[0]) : null;
  }

  async function geocodeAddress(address) {
    const url =
      'https://maps.googleapis.com/maps/api/geocode/json?address=' +
      encodeURIComponent(address) +
      '&region=uk&key=AIzaSyB09BZbYfyLs4cFe9Vr98OV3PQ3QaeJIPA';

    const res = await fetch(url);
    const data = await res.json();

    if (data.status === 'OK' && data.results.length > 0) {
      return data.results[0].geometry.location;
    } else {
      throw new Error('Geocoding failed: ' + data.status);
    }
  }

  function fakeGeocode(text) {
    const s=(text||'').toLowerCase();
    let hash=0;
    for(let i=0;i<s.length;i++){hash=(hash*31+s.charCodeAt(i))&0xffffffff;}
    const minLat=50, maxLat=56, minLng=-5.5, maxLng=1.5;
    const lat=minLat+(Math.abs(hash)%1000)/1000*(maxLat-minLat);
    const lng=minLng+(Math.abs(hash>>1)%1000)/1000*(maxLng-minLng);
    return {lat,lng};
  }

  // ---------- Seed 3 default loads on every page load ----------
  function seedDemoLoads() {
    if (allLoads.length > 0) return;

    const demoLoads = [
      {
        id: 'demo-1',
        pickup_location: 'BD4 6SE – Wakefield DC',
        delivery_location: 'RM9 6BF – Dagenham RDC',
        pickup_window: '24/11/2025 08:00-10:00',
        delivery_window: '24/11/2025 14:00-15:00',
        load_type: 'Chilled',
        trailer_type: 'Single-deck fridge',
        pallets: '26 pallets',
        pallet_count: 26,
        weight_kg: 24000,
        target_rate: 650,
        status: 'Open',

        pickup_lat: 53.753724,
        pickup_lng: -1.737594,
        delivery_lat: 51.521373,
        delivery_lng: 0.140346,

        main_route_info: {
          distance: '~320 km',
          eta: '~4h 0m'
        },
        main_route_km: 320,
        main_route_secs: 4 * 3600
      },
      {
        id: 'demo-2',
        pickup_location: 'OL12 9QJ – Northern DC',
        delivery_location: 'LE19 1SW – Midlands RDC',
        pickup_window: '25/11/2025 06:00-08:00',
        delivery_window: '25/11/2025 11:00-12:00',
        load_type: 'Frozen',
        trailer_type: 'Double-deck fridge',
        pallets: '40 pallets',
        pallet_count: 40,
        weight_kg: 26000,
        target_rate: 780,
        status: 'Open',

        pickup_lat: 53.639009,
        pickup_lng: -2.124815,
        delivery_lat: 52.599032,
        delivery_lng: -1.189747,

        main_route_info: {
          distance: '~190 km',
          eta: '~2h 15m'
        },
        main_route_km: 190,
        main_route_secs: (2 * 3600) + (15 * 60)
      },
      {
        id: 'demo-3',
        pickup_location: 'M24 1RU – Manchester DC',
        delivery_location: 'BS11 9FG – Avonmouth RDC',
        pickup_window: '26/11/2025 09:00-11:00',
        delivery_window: '26/11/2025 15:00-17:00',
        load_type: 'Ambient',
        trailer_type: 'Curtainsider',
        pallets: '26 pallets',
        pallet_count: 26,
        weight_kg: 22000,
        target_rate: 600,
        status: 'Open',

        pickup_lat: 53.534306,
        pickup_lng: -2.173976,
        delivery_lat: 51.516994,
        delivery_lng: -2.689071,

        main_route_info: {
          distance: '~275 km',
          eta: '~3h 10m'
        },
        main_route_km: 275,
        main_route_secs: (3 * 3600) + (10 * 60)
      }
    ];

    allLoads = demoLoads;
  }
  // ---------------------------------------------------------------

  function renderLoadsForShipper(){
    const c=document.getElementById('shipper-load-list');
    if (!c) return;
    const active=allLoads;
    if(active.length===0){
      c.innerHTML='<div class="li-meta">No loads yet. Post your first MileZero° load above.</div>';
      return;
    }

    c.innerHTML=active.map(l=>{
      const quoteStatusReadable =
        l.quote_status === 'accepted'
          ? 'Accepted'
          : l.quote_status === 'declined'
            ? 'Declined'
            : (typeof l.my_quote === 'number' ? 'Pending' : null);

      const quoteLine =
        typeof l.my_quote === 'number'
          ? `<div class="li-meta">Quote received: £${escapeHtml(l.my_quote.toFixed(0))}${quoteStatusReadable ? ' · Status: ' + escapeHtml(quoteStatusReadable) : ''}</div>`
          : '';

      let actionsHtml = `<button class="btn secondary" type="button" onclick="openLoadDetail('${l.id}')">Load details</button>`;

      if (typeof l.my_quote === 'number') {
        if (!l.quote_status || l.quote_status === 'pending') {
          actionsHtml += `
            <button class="btn" type="button" onclick="acceptQuote('${l.id}')">Accept</button>
            <button class="btn secondary" type="button" onclick="declineQuote('${l.id}')">Decline</button>
          `;
        } else if (l.quote_status === 'accepted') {
          actionsHtml += `<span class="li-meta">Quote accepted</span>`;
        } else if (l.quote_status === 'declined') {
          actionsHtml += `<span class="li-meta">Quote declined</span>`;
        }
      }

      return `
      <div class="list-item">
        <div class="li-main">
          <strong>${escapeHtml(l.pickup_location)} → ${escapeHtml(l.delivery_location)}</strong>
          <div class="li-meta">
            ${escapeHtml(l.pickup_window)} ·
            ${escapeHtml(l.pallets||'')} ·
            ${escapeHtml(l.load_type||'')} ·
            ${escapeHtml(l.trailer_type||'')}
          </div>
          ${quoteLine}
          <span class="status">${l.status||'Open'}</span>
        </div>
        <div class="li-actions">
          ${actionsHtml}
        </div>
      </div>`;
    }).join('');
  }

  function kmOrInfinity(val) {
    return (typeof val === 'number' && isFinite(val)) ? val : Infinity;
  }

  function combinedKm(load) {
    const a = typeof load.deadhead_km === 'number' ? load.deadhead_km : 0;
    const b = typeof load.main_route_km === 'number' ? load.main_route_km : 0;
    const c = typeof load.delivery_to_base_km === 'number' ? load.delivery_to_base_km : 0;
    if (a === 0 && b === 0 && c === 0) return null;
    return a + b + c;
  }

  function totalDurationSeconds(load) {
    let s = 0;
    if (typeof load.deadhead_secs === 'number') s += load.deadhead_secs;
    if (typeof load.main_route_secs === 'number') s += load.main_route_secs;
    if (typeof load.delivery_to_base_secs === 'number') s += load.delivery_to_base_secs;
    return s || null;
  }

  function formatDistanceKm(km) {
    if (km == null) return '–';
    const rounded = Math.round(km * 10) / 10;
    return rounded + ' km';
  }

  function formatDurationFromSeconds(seconds) {
    if (seconds == null) return 'N/A';
    const mins = Math.round(seconds / 60);
    if (mins < 60) return mins + ' mins';
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return m ? `${h}h ${m}m` : `${h}h`;
  }

  function extractLocationCode(str) {
    if (!str) return '';
    const beforeDash = str.split(/[–-]/)[0].trim();
    return beforeDash;
  }

  function renderLoadsForHaulier(){
    const c=document.getElementById('haulier-load-list');
    if (!c) return;

    if (!baseCoords) {
      c.innerHTML = '<div class="li-meta">Enter your base postcode above and press Search to see matching loads.</div>';
      return;
    }

    let filtered=allLoads.filter(l=>{
      const tempOk = haulierFilter.temperature==='Any' || (l.load_type||'').toLowerCase()===haulierFilter.temperature.toLowerCase();
      const trailerOk = haulierFilter.trailer==='Any' || (l.trailer_type||'').toLowerCase().includes(haulierFilter.trailer.toLowerCase());

      const palletsOk =
        haulierFilter.maxPallets == null ||
        l.pallet_count == null ||
        l.pallet_count <= haulierFilter.maxPallets;

      const weightOk =
        haulierFilter.maxWeightKg == null ||
        l.weight_kg == null ||
        l.weight_kg <= haulierFilter.maxWeightKg;

      return tempOk && trailerOk && palletsOk && weightOk;
    });

    if (sortOption === 'deadhead') {
      filtered = filtered.slice().sort((a,b) => {
        return kmOrInfinity(a.deadhead_km) - kmOrInfinity(b.deadhead_km);
      });
    } else if (sortOption === 'combined') {
      filtered = filtered.slice().sort((a,b) => {
        const ak = combinedKm(a);
        const bk = combinedKm(b);
        if (ak == null && bk == null) return 0;
        if (ak == null) return 1;
        if (bk == null) return -1;
        return ak - bk;
      });
    }

    if(filtered.length===0){
      c.innerHTML='<div class="li-meta">No matching loads for this base / filter. Try widening your criteria.</div>';
      return;
    }

    c.innerHTML=filtered.map(l=>{
      const totalKm = combinedKm(l);
      const totalSecs = totalDurationSeconds(l);
      const combinedDistanceText = formatDistanceKm(totalKm);
      const combinedEtaText = formatDurationFromSeconds(totalSecs);

      const priceText =
        typeof l.target_rate === 'number'
          ? '£' + l.target_rate.toFixed(0)
          : '–';

      const statusReadable =
        l.quote_status === 'accepted'
          ? 'Accepted'
          : l.quote_status === 'declined'
            ? 'Declined'
            : (typeof l.my_quote === 'number' ? 'Pending' : null);

      const yourQuoteText =
        typeof l.my_quote === 'number'
          ? `Your quote: £${l.my_quote.toFixed(0)}${statusReadable ? ' (' + escapeHtml(statusReadable) + ')' : ''}`
          : '';

      return `
      <div class="list-item">
        <div class="li-main">
          <strong>Collection: ${escapeHtml(l.pickup_location)}</strong>
          <div class="li-meta">Delivery: ${escapeHtml(l.delivery_location)}</div>
          <div class="li-meta">
            Total Driving: ${escapeHtml(combinedDistanceText)} · ETA: ${escapeHtml(combinedEtaText)}
          </div>
          <div class="li-meta">
            Price: ${escapeHtml(priceText)}
            ${yourQuoteText ? ' · ' + yourQuoteText : ''}
          </div>
        </div>
        <div class="li-actions">
          <button class="btn" type="button" onclick="openLoadDetail('${l.id}')">Load details</button>
          <button class="btn secondary" type="button" onclick="submitQuote('${l.id}')">Quote</button>
        </div>
      </div>`;
    }).join('');
  }

  function renderAll(){renderLoadsForShipper();renderLoadsForHaulier();}

  function validateDateTimeWindow(v){
    if(!v) return false;
    const re=/^([0-2][0-9]|3[0-1])\/(0[1-9]|1[0-2])\/(\d{4})\s+([0-1][0-9]|2[0-3]):([0-5][0-9])\s*-\s*([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
    return re.test(v.trim());
  }

  async function publishLoad(){
    const pickup=document.getElementById('pickup-input').value.trim();
    const delivery=document.getElementById('delivery-input').value.trim();
    const pickupWindow=document.getElementById('pickup-window-input').value.trim();
    const deliveryWindow=document.getElementById('delivery-window-input').value.trim();
    if(!pickup || !delivery){alert('Please enter pickup and delivery.');return;}
    if(!validateDateTimeWindow(pickupWindow) || !validateDateTimeWindow(deliveryWindow)){
      alert('Date/time windows must be in format DD/MM/YYYY HH:MM-HH:MM');return;
    }

    const palletsText = document.getElementById('pallets-input').value.trim();
    const weightText = document.getElementById('weight-input').value.trim();
    const targetRateText = document.getElementById('target-rate-input').value;

    const payload={
      id:Date.now().toString(),
      pickup_location:pickup,
      delivery_location:delivery,
      pickup_window:pickupWindow,
      delivery_window:deliveryWindow,
      load_type:document.getElementById('load-type-input').value,
      trailer_type:document.getElementById('trailer-type-input').value,
      pallets:palletsText,
      pallet_count: parseNumberFromText(palletsText),
      weight_kg: parseNumberFromText(weightText),
      target_rate: targetRateText ? Number(targetRateText) : null,
      status:'Open'
    };

    let p, d;
    try {
      p = await geocodeAddress(pickup);
      d = await geocodeAddress(delivery);
    } catch (err) {
      console.warn('Geocoding failed, falling back to fake coords', err);
      p = fakeGeocode(pickup);
      d = fakeGeocode(delivery);
    }

    payload.pickup_lat=p.lat; payload.pickup_lng=p.lng;
    payload.delivery_lat=d.lat; payload.delivery_lng=d.lng;

    allLoads.unshift(payload);
    document.getElementById('shipper-form').reset();
    renderAll();
    refreshRouteInfoForAllLoads();
    alert('Load published.');
  }

  async function applyHaulierFilters(){
    const baseInput = document.getElementById('haulier-base');
    const maxPalletsInput = document.getElementById('haulier-max-pallets');
    const maxWeightInput = document.getElementById('haulier-max-weight');
    const sortSel = document.getElementById('haulier-sort');

    baseLocationString = baseInput.value.trim();
    if (!baseLocationString) {
      baseCoords = null;
      renderLoadsForHaulier();
      alert('Please enter your base postcode before searching for loads.');
      return;
    }

    haulierFilter.trailer = document.getElementById('haulier-trailer').value;
    haulierFilter.temperature = document.getElementById('haulier-temp').value;
    haulierFilter.maxPallets = maxPalletsInput.value ? Number(maxPalletsInput.value) : null;
    haulierFilter.maxWeightKg = maxWeightInput.value ? Number(maxWeightInput.value) : null;
    sortOption = sortSel ? sortSel.value : 'default';

    try {
      baseCoords = await geocodeAddress(baseLocationString);
    } catch (err) {
      console.warn('Base geocoding failed', err);
      alert('Could not geocode that base location. Please check the postcode.');
      baseCoords = null;
      renderLoadsForHaulier();
      return;
    }

    await refreshRouteInfoForAllLoads();
  }

  function clearMapOverlays(){
    if(!map) return;
    mapMarkers.forEach(m=>m.setMap(null)); mapMarkers=[];
    if(mainRoutePolyline){mainRoutePolyline.setMap(null); mainRoutePolyline=null;}
    if(deadheadPolyline){deadheadPolyline.setMap(null); deadheadPolyline=null;}
  }

  function getRoute(origin, destination) {
    return new Promise((resolve) => {
      if (!directionsService) { resolve(null); return; }
      directionsService.route(
        {
          origin,
          destination,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: new Date(),
            trafficModel: google.maps.TrafficModel.BEST_GUESS || 'best_guess'
          }
        },
        (res, status) => {
          if (status === 'OK' && res.routes && res.routes.length > 0) {
            resolve(res.routes[0]);
          } else {
            console.warn('Route failed:', status, res);
            resolve(null);
          }
        }
      );
    });
  }

  async function computeRouteInfoForLoad(load) {
    if (!directionsService) return;
    if (typeof load.pickup_lat !== 'number' || typeof load.delivery_lat !== 'number') return;

    const pickupPos = { lat: load.pickup_lat, lng: load.pickup_lng };
    const deliveryPos = { lat: load.delivery_lat, lng: load.delivery_lng };

    const mainRoute = await getRoute(pickupPos, deliveryPos);
    if (mainRoute && mainRoute.legs && mainRoute.legs.length > 0) {
      const leg = mainRoute.legs[0];
      const distText = leg.distance && leg.distance.text ? leg.distance.text : '';
      const baseSecs = leg.duration_in_traffic && typeof leg.duration_in_traffic.value === 'number'
        ? leg.duration_in_traffic.value
        : (leg.duration && typeof leg.duration.value === 'number' ? leg.duration.value : null);
      const etaText =
        leg.duration_in_traffic && leg.duration_in_traffic.text
          ? leg.duration_in_traffic.text
          : (leg.duration && leg.duration.text ? leg.duration.text : '');

      if (distText && etaText) {
        load.main_route_info = { distance: distText, eta: etaText };
        load.main_route_km = leg.distance && typeof leg.distance.value === 'number'
          ? leg.distance.value / 1000
          : null;
        load.main_route_secs = baseSecs;
      }
    }

    if (userLocation) {
      const deadRoute = await getRoute(userLocation, pickupPos);
      if (deadRoute && deadRoute.legs && deadRoute.legs.length > 0) {
        const leg = deadRoute.legs[0];
        const distText = leg.distance && leg.distance.text ? leg.distance.text : '';
        const baseSecs = leg.duration_in_traffic && typeof leg.duration_in_traffic.value === 'number'
          ? leg.duration_in_traffic.value
          : (leg.duration && typeof leg.duration.value === 'number' ? leg.duration.value : null);
        const etaText =
          leg.duration_in_traffic && leg.duration_in_traffic.text
            ? leg.duration_in_traffic.text
            : (leg.duration && leg.duration.text ? leg.duration.text : '');

        if (distText && etaText) {
          load.deadhead_info = { distance: distText, eta: etaText };
          load.deadhead_km = leg.distance && typeof leg.distance.value === 'number'
            ? leg.distance.value / 1000
            : null;
          load.deadhead_secs = baseSecs;
        }
      }
    }

    if (baseCoords) {
      const baseRoute = await getRoute(deliveryPos, baseCoords);
      if (baseRoute && baseRoute.legs && baseRoute.legs.length > 0) {
        const leg = baseRoute.legs[0];
        const distText = leg.distance && leg.distance.text ? leg.distance.text : '';
        const baseSecs = leg.duration_in_traffic && typeof leg.duration_in_traffic.value === 'number'
          ? leg.duration_in_traffic.value
          : (leg.duration && typeof leg.duration.value === 'number' ? leg.duration.value : null);
        const etaText =
          leg.duration_in_traffic && leg.duration_in_traffic.text
            ? leg.duration_in_traffic.text
            : (leg.duration && leg.duration.text ? leg.duration.text : '');

        if (distText && etaText) {
          load.delivery_to_base_info = { distance: distText, eta: etaText };
          load.delivery_to_base_km = leg.distance && typeof leg.distance.value === 'number'
            ? leg.distance.value / 1000
            : null;
          load.delivery_to_base_secs = baseSecs;
        }
      }
    }
  }

  async function refreshRouteInfoForAllLoads() {
    if (!directionsService) {
      renderLoadsForHaulier();
      return;
    }
    const loadsCopy = [...allLoads];
    for (const l of loadsCopy) {
      await computeRouteInfoForLoad(l);
    }
    renderLoadsForHaulier();
  }

  function showLoadOnMap(load){
    if(!map){return;}
    if(typeof load.pickup_lat!=='number' || typeof load.delivery_lat!=='number'){
      return;
    }

    const pickupPos={lat:load.pickup_lat,lng:load.pickup_lng};
    const deliveryPos={lat:load.delivery_lat,lng:load.delivery_lng};

    clearMapOverlays();

    mapMarkers.push(new google.maps.Marker({position:pickupPos,map,label:'C',title:load.pickup_location}));
    mapMarkers.push(new google.maps.Marker({position:deliveryPos,map,label:'D',title:load.delivery_location}));

    const bounds = new google.maps.LatLngBounds();
    bounds.extend(pickupPos);
    bounds.extend(deliveryPos);
    if (userLocation) bounds.extend(userLocation);
    if (baseCoords) bounds.extend(baseCoords);

    if (!directionsService) {
      map.fitBounds(bounds, 80);
      return;
    }

    getRoute(pickupPos, deliveryPos).then(route => {
      if (route) {
        if (mainRoutePolyline) mainRoutePolyline.setMap(null);
        mainRoutePolyline = new google.maps.Polyline({
          map,
          path: route.overview_path,
          strokeOpacity: 0.9
        });

        if (route.bounds) bounds.union(route.bounds);

        if (route.legs && route.legs.length > 0) {
          const leg = route.legs[0];
          const distText = leg.distance && leg.distance.text ? leg.distance.text : '';
          const baseSecs = leg.duration_in_traffic && typeof leg.duration_in_traffic.value === 'number'
            ? leg.duration_in_traffic.value
            : (leg.duration && typeof leg.duration.value === 'number' ? leg.duration.value : null);
          const etaText =
            leg.duration_in_traffic && leg.duration_in_traffic.text
              ? leg.duration_in_traffic.text
              : (leg.duration && leg.duration.text ? leg.duration.text : '');

          if (distText && etaText) {
            load.main_route_info = { distance: distText, eta: etaText };
            load.main_route_km = leg.distance && typeof leg.distance.value === 'number'
              ? leg.distance.value / 1000
              : null;
            load.main_route_secs = baseSecs;
          }
        }
      }

      map.fitBounds(bounds, 80);
    });

    if (userLocation) {
      getRoute(userLocation, pickupPos).then(route => {
        if (route) {
          if (deadheadPolyline) deadheadPolyline.setMap(null);
          deadheadPolyline = new google.maps.Polyline({
            map,
            path: route.overview_path,
            strokeOpacity: 0.9,
            strokeColor: '#4285F4',
            strokeWeight: 4
          });

          if (route.legs && route.legs.length > 0) {
            const leg = route.legs[0];
            const distText = leg.distance && leg.distance.text ? leg.distance.text : '';
            const baseSecs = leg.duration_in_traffic && typeof leg.duration_in_traffic.value === 'number'
              ? leg.duration_in_traffic.value
              : (leg.duration && typeof leg.duration.value === 'number' ? leg.duration.value : null);
            const etaText =
              leg.duration_in_traffic && leg.duration_in_traffic.text
                ? leg.duration_in_traffic.text
                : (leg.duration && leg.duration.text ? leg.duration.text : '');

            if (distText && etaText) {
              load.deadhead_info = { distance: distText, eta: etaText };
              load.deadhead_km = leg.distance && typeof leg.distance.value === 'number'
                ? leg.distance.value / 1000
                : null;
              load.deadhead_secs = baseSecs;
            }
          }
        }
      });
    }
  }

  function submitQuote(id) {
    const load = allLoads.find(l => String(l.id) === String(id));
    if (!load) {
      alert('Load not found.');
      return;
    }

    const input = prompt('Enter your quote price (£):', load.my_quote != null ? load.my_quote : (load.target_rate || ''));
    if (input === null) return;

    const value = Number(input);
    if (!isFinite(value) || value <= 0) {
      alert('Please enter a valid positive number.');
      return;
    }

    load.my_quote = value;
    load.quote_status = 'pending'; // reset to pending if they change it
    alert('Quote submitted: £' + value.toFixed(0));

    renderLoadsForHaulier();
    renderLoadsForShipper();

    if (selectedLoadId && String(selectedLoadId) === String(id)) {
      openLoadDetail(id);
    }
  }

  function acceptQuote(id) {
    const load = allLoads.find(l => String(l.id) === String(id));
    if (!load) {
      alert('Load not found.');
      return;
    }
    if (typeof load.my_quote !== 'number') {
      alert('No quote to accept for this load.');
      return;
    }
    load.quote_status = 'accepted';
    alert('Quote accepted.');
    renderAll();
    if (selectedLoadId && String(selectedLoadId) === String(id)) {
      openLoadDetail(id);
    }
  }

  function declineQuote(id) {
    const load = allLoads.find(l => String(l.id) === String(id));
    if (!load) {
      alert('Load not found.');
      return;
    }
    if (typeof load.my_quote !== 'number') {
      alert('No quote to decline for this load.');
      return;
    }
    load.quote_status = 'declined';
    alert('Quote declined.');
    renderAll();
    if (selectedLoadId && String(selectedLoadId) === String(id)) {
      openLoadDetail(id);
    }
  }

  async function openLoadDetail(id){
    const load = allLoads.find(l => String(l.id) === String(id));
    if (!load) {
      alert('Load not found.');
      return;
    }
    selectedLoadId = id;

    await computeRouteInfoForLoad(load);

    const pickupCode = extractLocationCode(load.pickup_location).toUpperCase();
    const deliveryCode = extractLocationCode(load.delivery_location).toUpperCase();

    const totalKm = combinedKm(load);
    const totalSecs = totalDurationSeconds(load);
    const totalDistStr = formatDistanceKm(totalKm);
    const totalEtaStr = formatDurationFromSeconds(totalSecs);

    const priceText =
      typeof load.target_rate === 'number'
        ? '£' + load.target_rate.toFixed(0)
        : 'Not set';

    const statusReadable =
      load.quote_status === 'accepted'
        ? 'Accepted'
        : load.quote_status === 'declined'
          ? 'Declined'
          : (typeof load.my_quote === 'number' ? 'Pending' : null);

    const yourQuoteText =
      typeof load.my_quote === 'number'
        ? 'Your quote: £' + load.my_quote.toFixed(0) + (statusReadable ? ' (' + statusReadable + ')' : '')
        : '';

    const deadheadLine = load.deadhead_info
      ? `You → Collection: ${escapeHtml(load.deadhead_info.distance)} · ETA: ${escapeHtml(load.deadhead_info.eta)}`
      : 'You → Collection: N/A';

    const mainRouteLine = load.main_route_info
      ? `Collection → Delivery: ${escapeHtml(load.main_route_info.distance)} · ETA: ${escapeHtml(load.main_route_info.eta)}`
      : 'Collection → Delivery: N/A';

    const deliveryBaseLine = load.delivery_to_base_info
      ? `Delivery → Base: ${escapeHtml(load.delivery_to_base_info.distance)} · ETA: ${escapeHtml(load.delivery_to_base_info.eta)}`
      : 'Delivery → Base: N/A';

    const pickupWindowLine = 'Pickup Window: ' + escapeHtml(load.pickup_window || 'N/A');
    const deliveryWindowLine = 'Delivery Window: ' + escapeHtml(load.delivery_window || 'N/A');

    const palletsValue =
      load.pallet_count != null
        ? String(load.pallet_count)
        : (load.pallets || 'N/A');
    const palletsLine = 'No. of pallets: ' + escapeHtml(palletsValue);

    const loadTypeLine = 'Load Type: ' + escapeHtml(load.load_type || 'N/A');
    const trailerTypeLine = 'Trailer Type: ' + escapeHtml(load.trailer_type || 'N/A');

    const summaryEl = document.getElementById('detail-summary');

    summaryEl.innerHTML =
      `<div class="li-meta">Total Driving: ${escapeHtml(totalDistStr)} ${escapeHtml(totalEtaStr)}</div>` +
      `<div class="li-meta">Collection: ${escapeHtml(pickupCode)}</div>` +
      `<div class="li-meta">Delivery: ${escapeHtml(deliveryCode)}</div>` +
      `<div class="li-meta">Price: ${escapeHtml(priceText)}</div>` +
      (yourQuoteText ? `<div class="li-meta">${escapeHtml(yourQuoteText)}</div>` : '') +
      `<div class="li-meta">${deadheadLine}</div>` +
      `<div class="li-meta">${mainRouteLine}</div>` +
      `<div class="li-meta">${deliveryBaseLine}</div>` +
      `<div class="li-meta">${pickupWindowLine}</div>` +
      `<div class="li-meta">${deliveryWindowLine}</div>` +
      `<div class="li-meta">${palletsLine}</div>` +
      `<div class="li-meta">${loadTypeLine}</div>` +
      `<div class="li-meta">${trailerTypeLine}</div>`;

    const routesEl = document.getElementById('detail-routes');
    if (routesEl) routesEl.innerHTML = '';

    showView('haulier-detail');

    showLoadOnMap(load);
  }

  window.initMap = function () {
    const mapEl=document.getElementById('detail-map');
    if(!mapEl) return;
    map=new google.maps.Map(mapEl,{
      center:{lat:53.8,lng:-1.6},
      zoom:6,
      disableDefaultUI:true,
      zoomControl:true
    });
    directionsService = new google.maps.DirectionsService();

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          if (userMarker) userMarker.setMap(null);
          userMarker = new google.maps.Marker({
            position: userLocation,
            map,
            title: 'Your location',
            icon: {
              url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            }
          });
          map.setCenter(userLocation);
          map.setZoom(9);
        },
        (err) => {
          console.warn('Geolocation error:', err);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } else {
      console.warn('Geolocation not supported in this browser.');
    }
  };

  window.addEventListener('DOMContentLoaded', () => {
    seedDemoLoads();
    renderAll();
  });
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB09BZbYfyLs4cFe9Vr98OV3PQ3QaeJIPA&callback=initMap"
  async
  defer
></script>

</body>
</html>
